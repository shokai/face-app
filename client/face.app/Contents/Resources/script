#!/usr/bin/env ruby

Dir.glob(File.dirname(__FILE__)+'/gems/*').each do |gem|
  $:.unshift gem+'/lib'
end

require 'yaml'
require 'httpclient'

begin
  @@conf = YAML::load open(File.dirname(__FILE__)+'/config.yml').read
rescue => e
  STDERR.puts e
  exit 1
end

c = HTTPClient.new
ARGV.each do |name|
  next unless File.exists? name
  begin
    puts res = c.post_content(@@conf['api']+'/file', {:file => open(name), :id => @@conf['id']})
    if res =~ /^https?:\/\/.+/
      system "echo #{res} | pbcopy"
      system "open #{res}"
    end
  rescue => e
    STDERR.puts e.res.body
    system "osascript -e 'tell application \"shokai\" to display dialog \"uplaod error - #{e.res.body}\"'"
  end
end
